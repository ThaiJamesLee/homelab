"use strict";(self.webpackChunkhomelab=self.webpackChunkhomelab||[]).push([[2187],{2821:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var t=s(4848),i=s(8453);const r={},o="Setup Authentik with OpenWebUI",a={id:"Authentik/OpenWebUI",title:"Setup Authentik with OpenWebUI",description:"I followed the steps described here//integrations.goauthentik.io/miscellaneous/open-webui/",source:"@site/docs/Authentik/OpenWebUI.md",sourceDirName:"Authentik",slug:"/Authentik/OpenWebUI",permalink:"/homelab/docs/Authentik/OpenWebUI",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Authentik/OpenWebUI.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Migrate to a bigger disk",permalink:"/homelab/docs/Proxmox/migrate-to-bigger-disk"},next:{title:"DDNS",permalink:"/homelab/docs/Networking/DDNS"}},l={},c=[{value:"Errors because of missing columns",id:"errors-because-of-missing-columns",level:2},{value:"How to alter the database",id:"how-to-alter-the-database",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"setup-authentik-with-openwebui",children:"Setup Authentik with OpenWebUI"}),"\n",(0,t.jsxs)(n.p,{children:["I followed the steps described here: ",(0,t.jsx)(n.a,{href:"https://integrations.goauthentik.io/miscellaneous/open-webui/",children:"https://integrations.goauthentik.io/miscellaneous/open-webui/"}),"\nHowever, after finishing the steps my OpenWebUI instance was not running. The logs showed issues with the sqlite database. It seems columns that are required for OAuth to work are missing."]}),"\n",(0,t.jsx)(n.h2,{id:"errors-because-of-missing-columns",children:"Errors because of missing columns"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"user"}),"\n",(0,t.jsx)(n.p,{children:"The user entity was missing the following columns:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"api_key"}),"\n",(0,t.jsx)(n.li,{children:"oauth_sub"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"group\nThe group entity was missing the following columns:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"user_ids"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Therefore, we need to add these columns to the ",(0,t.jsx)(n.code,{children:"webui.db"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"how-to-alter-the-database",children:"How to alter the database"}),"\n",(0,t.jsx)(n.p,{children:"First, backup your OpenWebUI database."}),"\n",(0,t.jsx)(n.p,{children:"Retrieve the database"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"docker cp open-webui:/app/backend/data/webui.db ./webui.db\n"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Make sure you have a sqlite3 client installed.\nMy OpenWebUI instance was running in a VM with as a docker compose stack.\nTherefore, I installed on my VM sqlite3 with ",(0,t.jsx)(n.code,{children:"sudo apt-get install sqlite3"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Alter the user table"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"ALTER TABLE user ADD COLUMN api_key TEXT;\nALTER TABLE user ADD COLUMN oauth_sub TEXT;\n"})}),"\n",(0,t.jsx)(n.p,{children:"Alter the group table"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:'ALTER TABLE "group" ADD COLUMN user_ids JSON;\n'})}),"\n",(0,t.jsx)(n.p,{children:"Once finished, we must migrate all users. Go to your Authentik user dashboard and edit your OpenWebUI application."}),"\n",(0,t.jsxs)(n.p,{children:["Go to ",(0,t.jsx)(n.code,{children:"Appications > Providers > Your OpenWebUI Provider > Preview"}),"\nIn ",(0,t.jsx)(n.code,{children:"Preview for User"})," select the user you want to migrate and copy in the ",(0,t.jsx)(n.code,{children:"JWT Payload"})," the value of the ",(0,t.jsx)(n.code,{children:"sub"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["In your webui.db, we must update for all users the ",(0,t.jsx)(n.code,{children:"oauth_sub"})," field. The value must be prefixed with ",(0,t.jsx)(n.code,{children:"oidc@"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:'UPDATE user SET oauth_sub = "oidc@<sub>" WHERE id = "<your-user-id>";\n'})}),"\n",(0,t.jsx)(n.p,{children:"Afterwards, bring your changes back to the open-webui instance."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:"docker cp ./webui.db open-webui:/app/backend/data/webui.db\n"})}),"\n",(0,t.jsx)(n.p,{children:"And restart your instance."}),"\n",(0,t.jsx)(n.p,{children:"The steps are beautifully described in this blog:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://dannytsang.com/migrating-open-webui-users-to-authentik/",children:"https://dannytsang.com/migrating-open-webui-users-to-authentik/"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var t=s(6540);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);