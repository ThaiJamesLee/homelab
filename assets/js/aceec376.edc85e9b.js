"use strict";(self.webpackChunkhomelab=self.webpackChunkhomelab||[]).push([[328],{4312:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>c,frontMatter:()=>t,metadata:()=>l,toc:()=>d});var s=o(4848),r=o(8453);const t={},i="GPU pass through",l={id:"Proxmox/gpu-passthrough",title:"GPU pass through",description:"All information here are from this reddit article//www.reddit.com/r/homelab/comments/b5xpua/theultimatebeginnersguidetogpupassthrough.",source:"@site/docs/Proxmox/gpu-passthrough.md",sourceDirName:"Proxmox",slug:"/Proxmox/gpu-passthrough",permalink:"/homelab/docs/Proxmox/gpu-passthrough",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Proxmox/gpu-passthrough.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Install and configure Proxmox",permalink:"/homelab/docs/Proxmox/"},next:{title:"How to mount a new storage disk",permalink:"/homelab/docs/Proxmox/how-to-mount-storage"}},a={},d=[{value:"Configure Grub",id:"configure-grub",level:2},{value:"VFIO Modules",id:"vfio-modules",level:2},{value:"IOMMU interrupt remapping",id:"iommu-interrupt-remapping",level:2},{value:"Blacklisting Drivers",id:"blacklisting-drivers",level:2},{value:"Adding GPU to VFIO",id:"adding-gpu-to-vfio",level:2},{value:"Sources",id:"sources",level:3}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"gpu-pass-through",children:"GPU pass through"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["All information here are from this reddit article: ",(0,s.jsx)(n.a,{href:"https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough",children:"https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough"}),".\nI wanted to keep a copy for myself here in case I want to create another VM with GPU pass through since this guide worked well for me."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Ensure that you ",(0,s.jsx)(n.strong,{children:"IOMMU"})," enabled in your BIOS settings!"]}),"\n",(0,s.jsx)(n.h2,{id:"configure-grub",children:"Configure Grub"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"nano /etc/default/grub\n"})}),"\n",(0,s.jsx)(n.p,{children:"Search for the line"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:'GRUB_CMDLINE_LINUX_DEFAULT="quiet"\n'})}),"\n",(0,s.jsx)(n.p,{children:"For AMD CPUs:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:'GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on"\n'})}),"\n",(0,s.jsx)(n.p,{children:"For Intel CPUs:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:'GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on"\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Additional commands"}),"\n"]}),"\n",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.p,{children:"You might need to add additional commands to this line, if the passthrough ends up failing. For example, if you're using a similar CPU as I am (Xeon E3-12xx series), which has horrible IOMMU grouping capabilities, and/or you are trying to passthrough a single GPU.\nThese additional commands essentially tell Proxmox not to utilize the GPUs present for itself, as well as helping to split each PCI device into its own IOMMU group. This is important because, if you try to use a GPU in say, IOMMU group 1, and group 1 also has your CPU grouped together for example, then your GPU passthrough will fail.\nHere are my grub command line settings:"}),"\n",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt pcie_acs_override=downstream,multifunction nofb nomodeset video=vesafb:off,efifb:off"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For more information on what these commands do and how they help:",(0,s.jsx)("br",{}),"\nA. Disabling the Framebuffer: video=vesafb",":off",",efifb",":off",(0,s.jsx)("br",{}),"\nB. ACS Override for IOMMU groups: pcie_acs_override=downstream,multifunction\nWhen you finished editing /etc/default/grub run this command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"update-grub\n"})}),"\n",(0,s.jsx)(n.h2,{id:"vfio-modules",children:"VFIO Modules"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"nano /etc/modules\n"})}),"\n",(0,s.jsx)(n.p,{children:"Paste the following lines into the file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:"vfio\nvfio_iommu_type1\nvfio_pci\nvfio_virqfd\n"})}),"\n",(0,s.jsx)(n.h2,{id:"iommu-interrupt-remapping",children:"IOMMU interrupt remapping"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'echo "options vfio_iommu_type1 allow_unsafe_interrupts=1" > /etc/modprobe.d/iommu_unsafe_interrupts.conf\necho "options kvm ignore_msrs=1" > /etc/modprobe.d/kvm.conf\n'})}),"\n",(0,s.jsx)(n.h2,{id:"blacklisting-drivers",children:"Blacklisting Drivers"}),"\n",(0,s.jsx)(n.p,{children:"The proxmox host should not use the GPUs, therefore, we blacklist the drivers."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'echo "blacklist radeon" >> /etc/modprobe.d/blacklist.conf\necho "blacklist nouveau" >> /etc/modprobe.d/blacklist.conf\necho "blacklist nvidia" >> /etc/modprobe.d/blacklist.conf\n'})}),"\n",(0,s.jsx)(n.h2,{id:"adding-gpu-to-vfio",children:"Adding GPU to VFIO"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"lspci -v\n"})}),"\n",(0,s.jsx)(n.p,{children:"Your shell window should output a bunch of stuff. Look for the line(s) that show your video card. It'll look something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"01:00.0 VGA compatible controller: NVIDIA Corporation GP104 [GeForce GTX 1070] (rev a1) (prog-if 00 [VGA controller])\n\n01:00.1 Audio device: NVIDIA Corporation GP104 High Definition Audio Controller (rev a1)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Make note of the first set of numbers (e.g. ",(0,s.jsx)(n.code,{children:"01:00.0"})," and ",(0,s.jsx)(n.code,{children:"01:00.1"}),"). We'll need them for the next step."]}),"\n",(0,s.jsx)(n.p,{children:"Run the command below. Replace 01:00 with whatever number was next to your GPU when you ran the previous command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"lspci -n -s 01:00\n"})}),"\n",(0,s.jsx)(n.p,{children:"Doing this should output your GPU card's Vendor IDs, usually one ID for the GPU and one ID for the Audio bus. It'll look a little something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"01:00.0 0000: 10de:1b81 (rev a1)\n\n01:00.1 0000: 10de:10f0 (rev a1)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["What we want to keep, are these vendor id codes: ",(0,s.jsx)(n.code,{children:"10de:1b81"})," and ",(0,s.jsx)(n.code,{children:"10de:10f0"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Now we add the GPU's vendor id's to the VFIO (remember to replace the id's with your own!):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'echo "options vfio-pci ids=10de:1b81,10de:10f0 disable_vga=1"> /etc/modprobe.d/vfio.conf\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"update-initramfs -u\n"})}),"\n",(0,s.jsx)(n.h3,{id:"sources",children:"Sources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://pve.proxmox.com/wiki/PCI_Passthrough",children:"https://pve.proxmox.com/wiki/PCI_Passthrough"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough/",children:"https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough/"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.youtube.com/watch?v=S6jQx4AJlFw&t=870s",children:"https://www.youtube.com/watch?v=S6jQx4AJlFw&t=870s"})}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>l});var s=o(6540);const r={},t=s.createContext(r);function i(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);